<div class="page-std-padding-x page-std-padding-y space-y-8 std-shaded-bg min-h-screen">
    <h1 class="text-3xl font-bold movie-title mb-6 text-center">User Profile</h1>

    <!-- Loading State -->
    <div *ngIf="isLoadingProfile" class="flex items-center justify-center py-40">
        <div class="text-center std-shaded-text">
            <fa-icon [icon]="faSpinner" [animation]="'spin'" size="3x"></fa-icon>
            <p class="mt-2 text-lg font-semibold">Loading profile...</p>
        </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!isLoadingProfile && (isForbidden || profileLoadError)" class="py-20">
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-md mx-auto" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline"> {{ profileLoadError }}</span>
        </div>
        <div class="flex items-center justify-center w-full">
            <a
                *ngIf="isForbidden"
                class="mt-4 standard-write-button"
                [routerLink]="'/search-public-users'"
            >
                Discover Public Profiles
            </a>
        </div>
    </div>

    <div *ngIf="!isLoadingProfile && profileUser && !isForbidden && !profileLoadError" class="flex flex-col items-center mb-8">
        <div class="w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center text-blue-800 text-5xl font-bold border-2 border-blue-400">
            <ng-container *ngIf="profileUser?.displayName; else defaultAvatar">
                {{ profileUser.displayName?.charAt(0)?.toUpperCase() }}
            </ng-container>
            <ng-template #defaultAvatar>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </ng-template>
        </div>
        <h2 class="mt-4 text-2xl font-semibold">
            {{ profileUser.displayName ?? 'New User' }}
        </h2>
        <p class="text-sm text-gray-500">
            {{ profileUser.email }} </p>
    </div>

    <div *ngIf="!isLoadingProfile && profileUser && !isForbidden && !profileLoadError" class="max-w-xl mx-auto std-bg p-6 rounded-lg shadow-md space-y-4">
        <h3 class="text-xl font-semibold border-b pb-3 mb-4">Personal Information</h3>

        <div class="flex items-center space-x-2 text-lg">
            <div class="font-semibold w-36 flex-shrink-0">
                Display Name:
            </div>
            <div class="flex-grow">
                {{ profileUser.displayName ?? '-' }}
            </div>
        </div>

        <div class="flex items-center space-x-2 text-lg">
            <div class="font-semibold w-36 flex-shrink-0">
                Email:
            </div>
            <div class="flex-grow">
                {{ profileUser.email }}
            </div>
        </div>
    </div>

    <div *ngIf="!isLoadingProfile && profileUser && !isForbidden && !profileLoadError" class="max-w-xl mx-auto std-bg p-6 rounded-lg shadow-md space-y-4 mt-6">
        <h3 class="text-xl font-semibold std-shaded-text border-b pb-3 mb-4">Account Activity</h3>

        <div class="flex items-center space-x-2 text-lg">
            <div class="font-semibold w-36 flex-shrink-0">
                Joined At:
            </div>
            <div class="flex-grow">
                <ng-container *ngIf="profileUser?.createdAt; else noCreatedAt">
                    {{ profileUser.createdAt | date:'medium' }}
                </ng-container>
                <ng-template #noCreatedAt>-</ng-template>
            </div>
        </div>

        <div class="flex items-center space-x-2 text-lg">
            <div class="font-semibold w-36 flex-shrink-0">
                Last updated:
            </div>
            <div class="flex-grow">
                <ng-container *ngIf="profileUser?.updatedAt; else noUpdatedAt">
                    {{ profileUser.updatedAt | date:'medium' }}
                </ng-container>
                <ng-template #noUpdatedAt>-</ng-template>
            </div>
        </div>
    </div>

    <!-- Heatmap -->
    <div *ngIf="!isLoadingProfile && profileUser && !isForbidden && !profileLoadError" class="max-w-6xl mx-auto std-bg p-6 rounded-lg shadow-md mt-6">
        <h3 class="text-xl font-semibold std-shaded-text std-border-b pb-3 mb-4">Watching Activity</h3>
        <div class="flex flex-col xl:flex-row justify-start items-start">
            <div class="heatmap-main-content flex p-2 std-border rounded-md overflow-x-auto flex-grow min-w-0 w-full">
                <div class="flex flex-col justify-start mr-2 text-xs std-shaded-text pt-5 flex-shrink-0">
                    <div class="h-[13px] leading-none"></div> 
                    <div class="h-[13px] leading-none mb-1">Mon</div>
                    <div class="h-[13px] leading-none"></div>
                    <div class="h-[13px] leading-none mb-1">Wed</div>
                    <div class="h-[13px] leading-none"></div>
                    <div class="h-[13px] leading-none mb-1">Fri</div>
                    <div class="h-[13px] leading-none"></div>
                </div>

                <div class="flex flex-col">
                    <div class="flex mb-2 flex-nowrap space-x-9">
                        <ng-container *ngFor="let month of months; let i = index">
                            <div class="text-xs std-shaded-text text-left" [style.min-width.px]="i === months.length - 1 ? 0 : 40">{{ month }}</div>
                        </ng-container>
                    </div>

                    <div class="flex flex-nowrap">
                        <ng-container *ngFor="let week of calendarDays; let i = index">
                            <div class="flex flex-col space-y-1 mr-1 flex-shrink-0">
                                <ng-container *ngFor="let day of week">
                                    <div
                                        *ngIf="day.count !== -1"
                                        [class]="'w-[13px] h-[13px] rounded-sm ' + getHeatmapColor(day.count)"
                                        [title]="day.count + ' movies on ' + (day.date | date:'mediumDate')"
                                    ></div>
                                    <div
                                        *ngIf="day.count === -1"
                                        class="w-[13px] h-[13px] rounded-sm bg-transparent"
                                    ></div>
                                </ng-container>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
            
            <div class="ml-0 xl:ml-6 mt-4 xl:mt-0 flex flex-row xl:flex-col justify-center xl:justify-start items-center xl:items-start space-x-4 xl:space-x-0 xl:space-y-2 w-full xl:w-auto font-semibold">
                <button
                    *ngFor="let year of availableYears"
                    (click)="changeHeatmapYear(year)"
                    [ngClass]="{
                        'font-bold text-blue-700 bg-blue-100 shadow-md ring-2 ring-blue-400': year === currentHeatmapYear,
                        'text-gray-700 hover:bg-gray-200 active:bg-gray-300 hover:shadow-sm': year !== currentHeatmapYear
                    }"
                    class="px-3 py-1 rounded-md transition-all duration-200 ease-in-out text-sm whitespace-nowrap flex-shrink-0 cursor-pointer"
                >
                    {{ year }}
                </button>
            </div>
        </div>

        <div class="flex justify-end items-center mt-2 text-xs text-gray-500">
            Less
            <div class="w-[13px] h-[13px] rounded-sm bg-gray-200 ml-1 mr-0.5"></div>
            <div class="w-[13px] h-[13px] rounded-sm bg-green-100 mr-0.5"></div>
            <div class="w-[13px] h-[13px] rounded-sm bg-green-300 mr-0.5"></div>
            <div class="w-[13px] h-[13px] rounded-sm bg-green-500 mr-0.5"></div>
            <div class="w-[13px] h-[13px] rounded-sm bg-green-700 mr-1"></div>
            More
        </div>
    </div>

    <div *ngIf="!isLoadingProfile && profileUser && !isForbidden && !profileLoadError" class="flex justify-center space-x-4 mt-8">
        <a [routerLink]="'/edit-profile'" class="standard-write-button">
            Edit Profile
        </a>
        <a [href]="'/change-password'" class="standard-action-button">
            Change Password
        </a>
    </div>
</div>